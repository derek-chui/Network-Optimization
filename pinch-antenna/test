%bs at origin, pinch antennas A1 and A2, 2 users, try all antenna
%activiation combs, get noma rate with sic, pick best activation

clear;
clc;
close all;
rng('shuffle');

%params
% eta   = 3;
% P     = 1;
% N0    = 1e-4;
% alpha1 = 0.6;
% alpha2 = 0.4;
% sigma = 1;
% L     = 100;

%old params resulted in unrealistic sum rates
eta   = 3;
P     = 10;
N0    = 1e-5;
alpha1 = 0.6;
alpha2 = 0.4;
sigma = 1;
L     = 100;

%channel gain multiplier
%g_i = 1 + sum_k(act_k * Gk * coupling(user_i, ant_k))
%coupling(d) = 1 / (1 + (d/r0)^gamma), better for closer users
% G1 = 3.0;  %a1 active linear gain factor
% G2 = 3.0;  %same but a2
% r0 = 20;   %coupling length scale
% gamma = 2; % coupling roll off exp

%old params resulted in unrealistic sum rates
G1 = 6.0;
G2 = 6.0;
r0 = 40;
gamma = 1.5;

BS   = [0, 0];        
A1   = [ 50, 50];      
A2   = [-50, -50];      
U1   = (rand(1,2)*2-1)*L; 
U2   = (rand(1,2)*2-1)*L;

%helpers
rayleigh = @(s) s*sqrt(-2*log(max(1e-12,rand)));
d = @(x,y) max(1e-3, sqrt(sum((x-y).^2,2)));

coupling = @(dist) 1 ./ (1 + (dist./r0).^gamma);

noma_rates = @(hweak, hstrong) deal(log2(1 + (alpha1*P*hweak^2)/(alpha2*P*hweak^2 + N0)), log2(1 + (alpha2*P*hstrong^2)/N0) );                       

%BS to users
d1 = d(U1, BS);
z1 = rayleigh(sigma);
h1_direct = z1 / (d1^(eta/2));
d2 = d(U2, BS);
z2 = rayleigh(sigma);
h2_direct = z2 / (d2^(eta/2));

%pinch coupling to each user
c11 = coupling(d(U1, A1)); %U1 A1
c12 = coupling(d(U1, A2)); %U1 A2
c21 = coupling(d(U2, A1)); %U2 A1
c22 = coupling(d(U2, A2)); %U2 A2

%try all combinations
modes = [ 0 0;
          1 0;
          0 1;
          1 1 ];

results = struct('act',{},'h_eff',{},'R1',{},'R2',{},'sumR',{});

for m = 1:size(modes,1)
    a1 = modes(m,1);  a2 = modes(m,2);

    %gain mult
    g1 = 1 + a1*G1*c11 + a2*G2*c12;
    g2 = 1 + a1*G1*c21 + a2*G2*c22;

    %channels with pinch assistance
    h1 = h1_direct * g1;
    h2 = h2_direct * g2;

    %id weak/strong by channel magnitude
    if h1 <= h2
        [Rw, Rs] = noma_rates(h1, h2);
        map = 'U1 = weak, U2 = strong';
    else
        [Rw, Rs] = noma_rates(h2, h1);
        map = 'U2 = weak, U1 = strong';
    end

    results(m).act   = [a1,a2];
    results(m).h_eff = [h1,h2];
    results(m).R1 = Rw; %R weak
    results(m).R2 = Rs; %R strong
    results(m).sumR  = Rw + Rs;  
    results(m).map   = map;
end

%pick best activation
[~, idxBest] = max([results.sumR]);
best = results(idxBest);

%print summary
fprintf('User 1 (%.1f, %.1f)\n', U1);
fprintf('User 2 (%.1f, %.1f)\n', U2);
fprintf('%s\n', best.map);
fprintf('R Weak = %.3f\n', best.R1);
fprintf('R Strong = %.3f\n', best.R2);
fprintf('Sum Rate (R Weak + R Strong) = %.3f b/s/Hz\n', best.sumR);
fprintf('Best Activation (Highest Total Sum Rate): [A1 = %d, A2 = %d]\n', best.act(1), best.act(2));
fprintf('Channel Gain without Pinch Antennas: |h1| = %.4g, |h2| = %.4g\n', abs(h1_direct), abs(h2_direct));
fprintf('Channel Gain with Pinch Antennas: |h1p| = %.4g, |h2p| = %.4g\n', abs(best.h_eff(1)), abs(best.h_eff(2)));

%plot
figure('Color','w'); hold on; axis equal;
xlim([-L L]); ylim([-L L]);
xline(0,'k-','LineWidth',1);
yline(0,'k-','LineWidth',1);
box off
plot(BS(1),BS(2),'ks','MarkerFaceColor','k','MarkerSize',9); text(BS(1)+2,BS(2),'BS');
plot(A1(1),A1(2),'^','MarkerSize',9,'MarkerFaceColor',best.act(1)*[0 0 0]+[1 1 1], 'Color','k');
text(A1(1)+2,A1(2),'A1');
plot(A2(1),A2(2),'^','MarkerSize',9,'MarkerFaceColor',best.act(2)*[0 0 0]+[1 1 1], 'Color','k');
text(A2(1)+2,A2(2),'A2');

plot(U1(1),U1(2),'bo','MarkerFaceColor','b'); text(U1(1)+2,U1(2),'U1');
plot(U2(1),U2(2),'ro','MarkerFaceColor','r'); text(U2(1)+2,U2(2),'U2');

%bs to user lines
plot([BS(1) U1(1)],[BS(2) U1(2)],'b:');
plot([BS(1) U2(1)],[BS(2) U2(2)],'r:');

%active antenna to user lines
if best.act(1)
    plot([A1(1) U1(1)],[A1(2) U1(2)],'b-');
    plot([A1(1) U2(1)],[A1(2) U2(2)],'r-');
end
if best.act(2)
    plot([A2(1) U1(1)],[A2(2) U1(2)],'b-');
    plot([A2(1) U2(1)],[A2(2) U2(2)],'r-');
end

xlabel('x (m)'); ylabel('y (m)');
title(sprintf('2 Users with 2 Pinch Antennas'));
grid on;
